# Epic 3: Atlassian Confluence RAG Integration

## Epic Summary

Integrate Atlassian Confluence as a first-class content source for the RAG pipeline, enabling crawling of Confluence spaces and pages via the Atlassian REST API (both Cloud and On-Premise/Data Center), with full content processing and vector database storage — analogous to the existing web crawling capability but for authenticated Confluence content. Scope is limited to page body content; attachment processing (PDFs, images) is deferred to a future epic.

## Business Value

- **Enterprise Knowledge Access**: Confluence is the primary knowledge base in many organizations; making it searchable via RAG unlocks massive value
- **Authenticated Content**: Unlike web crawling, Confluence content sits behind authentication — API-based access is the correct approach
- **Cloud + On-Prem Support**: Covers both Atlassian Cloud (REST API v2) and On-Prem/Data Center (REST API v1) deployments
- **Multilingual Support**: Content is often mixed Czech and English (technical docs with English terms) — embedding models must handle both languages with equal semantic quality
- **On-Premise & Security Ready**: Architecture supports on-premise deployment in isolated environments (Docker), with future extensibility for user authentication and access control
- **Living Knowledge Base**: Incremental update mechanisms (scheduled sync, webhooks) keep the vector DB current as Confluence content evolves

## Stories

| Story | Title | Status |
|-------|-------|--------|
| 3.1 | [Atlassian Authentication Provider](3.1.atlassian-auth-provider.md) | Pending |
| 3.2 | [Confluence Content Crawler](3.2.confluence-content-crawler.md) | Pending |
| 3.3 | [Content Processing & RAG Storage](3.3.confluence-rag-storage.md) | Pending |
| 3.4 | [MCP Tools & Configuration](3.4.confluence-mcp-tools.md) | Pending |
| 3.5 | [Testing & Documentation](3.5.confluence-testing-docs.md) | Pending |

## Dependencies

- Existing AI Provider system (`src/ai_providers/`)
- Existing vector database providers (`src/database/`)
- Existing content chunking utilities (`src/utils_refactored.py`)
- Existing MCP tool registration pattern (`src/crawl4ai_mcp.py`)

## Architecture Overview

```
Confluence API (Cloud v2 / On-Prem v1)
        │
        ▼
┌─────────────────────┐
│ Atlassian Auth       │  ← 3.1: Basic Auth, PAT, OAuth 2.0
│ Provider             │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ Confluence Crawler   │  ← 3.2: Space/page traversal, pagination,
│                     │         content format conversion
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ Content Processor    │  ← 3.3: Chunking, embedding,
│ & RAG Storage        │         vector DB storage
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ MCP Tools            │  ← 3.4: crawl_confluence_space,
│                     │         crawl_confluence_page, config
└─────────────────────┘
```

## Key Technical Decisions

1. **API-based, not web scraping**: Use Atlassian REST API for reliable, structured content access
2. **Dual API support**: Cloud uses REST API v2 (`/wiki/api/v2/`), On-Prem uses v1 (`/rest/api/`)
3. **Three auth methods**: Basic Auth (Cloud), PAT/Bearer (On-Prem/DC), OAuth 2.0 (Enterprise Cloud)
4. **Reuse existing patterns**: Follow AI provider and database provider factory patterns
5. **Page content only**: Scope limited to Confluence page body content; attachment processing (PDFs, Word docs, images) deferred to future epic
6. **Multilingual embeddings**: Embedding model must support Czech and English equally — recommended models: `intfloat/multilingual-e5-large`, `BAAI/bge-m3`, or OpenAI `text-embedding-3-small` (which supports 100+ languages)
7. **Complex formatting preservation**: Tables, multi-tab pages, info/warning panels, expand macros — all converted to structured Markdown with readable text representation
8. **On-premise first**: Open-source vector DB (Qdrant, Weaviate, ChromaDB, Milvus), Docker-deployable, no vendor lock-in; must handle 100K+ embeddings efficiently with metadata filtering
9. **Security-ready architecture**: PoC without strict security, but architecture must support future addition of user authentication, access control, and data isolation
10. **Incremental content sync**: Scheduled re-crawl with version-based change detection + Confluence webhook listener for real-time updates

## Non-Functional Requirements (from PoC specification)

### Multilingual Support
- Content is Czech and English mixed (technical documentation with English terms)
- Embedding model must capture Czech text semantics with the same effectiveness as English
- LLM used for contextual embeddings and RAG must handle Czech fluently
- **Recommended embedding models**: `intfloat/multilingual-e5-large` (Ollama/vLLM), `BAAI/bge-m3`, OpenAI `text-embedding-3-small`

### Vector Database Requirements
- Open-source, on-premise capable (ChromaDB, Weaviate, Qdrant, Milvus)
- Performance: fast insert and search across hundreds of thousands of embeddings
- Metadata filtering support (by space, labels, language, date)
- Low TCO, no vendor lock-in
- Docker-deployable in isolated environment
- Future-proof: must support production on-premise or private cloud deployment

### Security Architecture (Future-Ready)
- PoC: no strict security requirements
- Architecture must support future: user authentication, role-based access to content, data encryption at rest
- Vector DB must be deployable in protected network environment
- No sensitive data leakage through embedding vectors

### Content Update Strategy
- **Scheduled sync**: Periodic re-crawl (cron-based) with version change detection — skip unchanged pages
- **Webhook-based updates** (future/optional): Confluence webhooks trigger re-processing of changed pages in near-real-time
- **Full re-index**: Manual trigger to rebuild entire space from scratch

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-19 | 1.0 | Initial epic creation | Rado |
| 2026-02-19 | 1.1 | Added multilingual (CS/EN), on-prem vector DB, security architecture, incremental sync requirements from PoC specification | Rado |
| 2026-02-19 | 1.2 | Removed attachment handling (page content only), fixed QA findings: SSL certs, OAuth headless, multilingual testability, page deletion sync, story scope | Rado |
