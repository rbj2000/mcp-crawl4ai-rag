# Story 3.1: Atlassian Authentication Provider

## Status
Pending

## Story
**As a** developer integrating Confluence with the MCP server,
**I want** a unified authentication provider supporting Basic Auth, PAT, and OAuth 2.0 for both Atlassian Cloud and On-Premise/Data Center,
**so that** I can securely connect to any Confluence deployment regardless of authentication method.

## Acceptance Criteria

### Functional Requirements
1. Basic Auth (username + API token) works for Atlassian Cloud instances
2. Personal Access Token (PAT/Bearer) works for On-Premise and Data Center instances
3. OAuth 2.0 (3-legged) works for enterprise Atlassian Cloud installations
4. Authentication provider auto-detects Cloud vs On-Prem based on URL pattern (*.atlassian.net = Cloud)
5. Token refresh is handled automatically for OAuth 2.0 (refresh token flow)
6. OAuth 2.0 initial token acquisition works in headless environments via pre-cached tokens (env vars `CONFLUENCE_OAUTH_ACCESS_TOKEN` / `CONFLUENCE_OAUTH_REFRESH_TOKEN`) or a one-time CLI setup command (`scripts/confluence_oauth_setup.py`) that handles the browser redirect flow
7. SSL/TLS certificate configuration for On-Prem instances: supports disabling verification (`CONFLUENCE_SSL_VERIFY=false`) and custom CA bundles (`CONFLUENCE_CA_BUNDLE=/path/to/cert.pem`)
8. Auth method auto-selection priority when `CONFLUENCE_AUTH_METHOD` is not set: OAuth 2.0 > PAT > Basic (based on available credentials)
9. Configuration via environment variables with sensible defaults

### Integration Requirements
10. Authentication provider follows existing provider factory pattern (`src/ai_providers/`)
11. HTTP client (aiohttp) sessions are reused with proper connection pooling
12. Auth headers are injected transparently — consumers don't deal with auth details
13. Graceful error handling for expired tokens, invalid credentials, and permission issues

### Quality Requirements
14. Unit tests cover all three auth methods with mocked responses
15. Integration test validates connectivity (skipped in CI if no credentials)
16. No hardcoded credentials — all secrets via environment variables

## Tasks / Subtasks

- [ ] **Design Atlassian Auth Provider Interface** (AC: 10, 12)
  - [ ] Create `src/atlassian/` package directory structure
  - [ ] Define `AtlassianAuthProvider` base class with `get_auth_headers()` method
  - [ ] Define `AtlassianConfig` dataclass for configuration
  - [ ] Define deployment type enum: `CLOUD`, `ON_PREM`, `DATA_CENTER`

- [ ] **Implement Basic Auth Provider** (AC: 1, 9)
  - [ ] Implement `BasicAuthProvider` for Cloud (username:api_token → Base64)
  - [ ] Validate required fields (CONFLUENCE_URL, CONFLUENCE_USERNAME, CONFLUENCE_API_TOKEN)
  - [ ] Add clear error messages for missing configuration

- [ ] **Implement PAT/Bearer Auth Provider** (AC: 2, 9)
  - [ ] Implement `PATAuthProvider` for On-Prem/DC (Bearer token)
  - [ ] Support both `CONFLUENCE_PAT` and `CONFLUENCE_API_TOKEN` env vars
  - [ ] Handle PAT expiration detection and user-friendly error messages

- [ ] **Implement OAuth 2.0 Provider** (AC: 3, 5, 6, 9)
  - [ ] Implement `OAuth2Provider` for enterprise Cloud
  - [ ] Implement authorization code exchange flow
  - [ ] Implement automatic token refresh using refresh tokens
  - [ ] Support pre-cached tokens via `CONFLUENCE_OAUTH_ACCESS_TOKEN` / `CONFLUENCE_OAUTH_REFRESH_TOKEN` env vars for headless operation
  - [ ] Handle OAuth scopes (read:confluence-content.all, read:confluence-space.summary)
  - [ ] Add `CONFLUENCE_OAUTH_CLIENT_ID`, `CONFLUENCE_OAUTH_CLIENT_SECRET`, `CONFLUENCE_OAUTH_REDIRECT_URI` env vars
  - [ ] Create `scripts/confluence_oauth_setup.py` — one-time CLI tool that opens browser, handles redirect, outputs tokens for env vars

- [ ] **Implement Auth Factory and Auto-Detection** (AC: 4, 8, 10)
  - [ ] Create `AtlassianAuthFactory` with `create_auth_provider()` method
  - [ ] Auto-detect Cloud vs On-Prem from URL (*.atlassian.net pattern)
  - [ ] Allow explicit override via `CONFLUENCE_DEPLOYMENT_TYPE` env var
  - [ ] Implement auth method auto-selection priority: OAuth2 > PAT > Basic (based on available credentials)

- [ ] **Implement SSL/TLS Certificate Configuration** (AC: 7)
  - [ ] Add `CONFLUENCE_SSL_VERIFY` env var (default: `true`)
  - [ ] Add `CONFLUENCE_CA_BUNDLE` env var for custom CA certificate path
  - [ ] Pass SSL configuration to aiohttp connector (`ssl=False` or custom `ssl.SSLContext`)
  - [ ] Log warning when SSL verification is disabled
  - [ ] Validate CA bundle file exists at startup if configured

- [ ] **HTTP Client Integration** (AC: 7, 11, 12, 13)
  - [ ] Create `AtlassianHTTPClient` wrapping aiohttp with auth injection
  - [ ] Implement connection pooling and session reuse
  - [ ] Apply SSL/TLS configuration from `AtlassianConfig`
  - [ ] Add retry logic with exponential backoff for transient errors
  - [ ] Handle rate limiting (429 responses) with Retry-After header
  - [ ] Map HTTP errors to clear exception types (AuthError, PermissionError, NotFoundError)
  - [ ] Add request/response logging (debug level, redact auth headers)

- [ ] **Configuration System** (AC: 9, 16)
  - [ ] Add all Confluence env vars to `.env.example`
  - [ ] Implement `AtlassianConfig.from_env()` factory method
  - [ ] Validate configuration completeness on startup
  - [ ] Add configuration validation script (`scripts/validate_confluence_config.py`)

## Dev Notes

### Environment Variables

```bash
# Confluence Connection
CONFLUENCE_URL=https://your-domain.atlassian.net/wiki  # Cloud
# or
CONFLUENCE_URL=https://confluence.your-company.com      # On-Prem

# Deployment Type (auto-detected if not set)
CONFLUENCE_DEPLOYMENT_TYPE=cloud  # cloud, on_prem, data_center

# Auth Method 1: Basic Auth (Cloud)
CONFLUENCE_AUTH_METHOD=basic
CONFLUENCE_USERNAME=your-email@company.com
CONFLUENCE_API_TOKEN=your-api-token

# Auth Method 2: PAT (On-Prem/Data Center)
CONFLUENCE_AUTH_METHOD=pat
CONFLUENCE_PAT=your-personal-access-token

# Auth Method 3: OAuth 2.0 (Enterprise Cloud)
CONFLUENCE_AUTH_METHOD=oauth2
CONFLUENCE_OAUTH_CLIENT_ID=your-client-id
CONFLUENCE_OAUTH_CLIENT_SECRET=your-client-secret
CONFLUENCE_OAUTH_REDIRECT_URI=http://localhost:8051/oauth/callback
CONFLUENCE_OAUTH_ACCESS_TOKEN=cached-access-token      # Optional: pre-cached
CONFLUENCE_OAUTH_REFRESH_TOKEN=cached-refresh-token    # Optional: for refresh

# SSL/TLS Configuration (On-Prem with self-signed certs)
CONFLUENCE_SSL_VERIFY=true                              # Set to false for self-signed certs
CONFLUENCE_CA_BUNDLE=/path/to/ca-bundle.crt             # Custom CA certificate path
```

### API Differences: Cloud vs On-Prem

| Feature | Cloud (v2) | On-Prem (v1) |
|---------|-----------|--------------|
| Base Path | `/wiki/api/v2/` | `/rest/api/` |
| Auth | Basic (email:token), OAuth 2.0 | PAT (Bearer), Basic (user:pass) |
| Pagination | Cursor-based (`_links.next`) | Offset-based (`start`, `limit`) |
| Content Format | Atlassian Document Format (ADF) | Storage format (XHTML) |
| Rate Limiting | Yes (429 + Retry-After) | Varies by deployment |

### Architecture

```
AtlassianAuthProvider (ABC)
  ├─ BasicAuthProvider     ← Cloud: email + API token
  ├─ PATAuthProvider       ← On-Prem/DC: Personal Access Token
  └─ OAuth2Provider        ← Enterprise Cloud: OAuth 2.0 (3LO)

AtlassianAuthFactory
  └─ create_auth_provider(config) → AtlassianAuthProvider

AtlassianHTTPClient
  ├─ auth_provider: AtlassianAuthProvider
  ├─ session: aiohttp.ClientSession
  └─ get(), post(), put(), delete() → with auth headers injected
```

### Reference Implementation

The existing JIRA MCP implementations at `/Users/radoslavbali-jencik/mcp/jira-cloud/` and `/Users/radoslavbali-jencik/mcp/jira-onprem/` provide reference for:
- Basic Auth and PAT authentication patterns
- URL parsing and request construction
- Error handling for Atlassian APIs

Key difference: those are Node.js with `https` module; this will be Python with `aiohttp`.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-19 | 1.0 | Initial story creation | Rado |
| 2026-02-19 | 1.1 | Added SSL/TLS cert configuration (AC 7), OAuth headless flow (AC 6), auth auto-selection priority (AC 8) per QA review | Rado |

## QA Results

### Review Date: 2026-02-19

### Reviewed By: Quinn (Test Architect)

### Story Quality Assessment

Well-structured story with clear AC, good separation of auth concerns, and solid architecture diagrams. The dev notes with API difference tables and reference implementations are excellent for implementation guidance.

### Compliance Check

- AC Completeness: CONCERNS — see findings below
- AC Testability: Pass — all ACs are verifiable
- Task-to-AC Traceability: Pass — all ACs mapped to tasks
- AC Numbering: Pass — sequential, no duplicates
- Story Format: Pass — follows established template

### Findings

- [ ] **SEC-3.1-001 (Medium): OAuth 2.0 initial authorization flow in headless environment** — AC 3 specifies OAuth 2.0 (3-legged) but the MCP server runs headless (Docker/CLI). The initial authorization code grant requires a browser redirect. Story should specify how the initial token acquisition works (e.g., separate CLI setup command, pre-cached tokens via env vars, or a one-time setup script). The `CONFLUENCE_OAUTH_ACCESS_TOKEN`/`CONFLUENCE_OAUTH_REFRESH_TOKEN` env vars in dev notes suggest pre-caching, but this should be an explicit AC.
- [ ] **SEC-3.1-002 (Medium): On-Prem self-signed SSL certificates** — Enterprise On-Prem Confluence instances often use self-signed or internal CA certificates. No AC or task covers SSL certificate configuration (e.g., `CONFLUENCE_SSL_VERIFY=true`, `CONFLUENCE_CA_BUNDLE=/path/to/cert.pem`). This will be a common deployment blocker.
- [ ] **SEC-3.1-003 (Low): Token storage security for OAuth 2.0** — Task mentions "Store tokens securely (configurable: env var, file, or memory)" but no AC validates this. For PoC this is acceptable, but should be documented as future security concern.
- [ ] **SPEC-3.1-001 (Low): Missing AC for auth method auto-selection priority** — AC 4 covers Cloud/On-Prem auto-detection but the auth method priority (OAuth2 > PAT > Basic) is only in tasks, not in ACs. Consider promoting to AC for testability.

### Risk Assessment

- **OAuth 2.0 complexity**: High scope for a single story. Consider whether OAuth 2.0 should be a separate follow-up story if PoC timeline is tight.
- **Dual API surface**: Cloud v2 vs On-Prem v1 differences propagate to all downstream stories. Good that the HTTP client abstracts this.

### Gate Status

Gate: CONCERNS → docs/qa/gates/3.1-atlassian-auth-provider.yml

### Recommended Status

Changes Recommended — Address SSL certificate handling (SEC-3.1-002) and OAuth headless flow (SEC-3.1-001) before implementation. Story owner decides final status.

---

### Re-Review Date: 2026-02-19

### Re-Reviewed By: Quinn (Test Architect)

### Story Quality Assessment

Excellent improvements since v1.0. All three critical findings from the initial review have been addressed with new ACs (6, 7, 8) and corresponding tasks. The story is now comprehensive and well-structured for implementation.

### Compliance Check

- AC Completeness: Pass — all auth methods, SSL, headless OAuth, and auto-selection covered
- AC Testability: Pass — all 16 ACs are verifiable
- Task-to-AC Traceability: Pass — all ACs mapped to tasks
- AC Numbering: Pass — sequential 1-16, no duplicates
- Story Format: Pass

### Findings (v1.1)

- [x] **SEC-3.1-001**: RESOLVED — AC 6 now specifies pre-cached tokens + CLI setup script
- [x] **SEC-3.1-002**: RESOLVED — AC 7 adds `CONFLUENCE_SSL_VERIFY` and `CONFLUENCE_CA_BUNDLE` with dedicated task
- [x] **SPEC-3.1-001**: RESOLVED — AC 8 promotes auth auto-selection priority to acceptance criteria
- [ ] **SEC-3.1-003 (Low): Token storage security for OAuth 2.0** — Still valid for future hardening. Acceptable for PoC scope. No action required now.
- [ ] **SPEC-3.1-002 (Low): OAuth 2.0 redirect URI conflict** — AC 6 mentions `scripts/confluence_oauth_setup.py` handles browser redirect, but the redirect URI in dev notes is `http://localhost:8051/oauth/callback` — port 8051 is the MCP server port. Consider using a separate port (e.g., 8052) to avoid conflict when MCP server is running. Minor — can be decided during implementation.

### Gate Status

Gate: PASS → docs/qa/gates/3.1-atlassian-auth-provider.yml

### Recommended Status

Ready for Implementation — All critical findings resolved. Remaining items are low-severity and can be addressed during implementation. Story owner decides final status.
