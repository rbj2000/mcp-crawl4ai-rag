# Story 3.2: Confluence Content Crawler

## Status
Pending

## Story
**As a** developer using the MCP server,
**I want** to crawl Confluence spaces and pages via the Atlassian REST API,
**so that** Confluence page content is available as structured data for RAG processing.

## Acceptance Criteria

### Functional Requirements
1. Crawl an entire Confluence space by space key, retrieving all pages with their content
2. Crawl a single Confluence page by page ID or URL
3. Handle pagination correctly for both Cloud (cursor-based) and On-Prem (offset-based)
4. Retrieve page metadata: title, author, last modified, labels, parent page, space
5. Convert Confluence content formats to clean, readable Markdown (ADF for Cloud, XHTML for On-Prem)
6. Complex formatting is preserved as structured text: tables → Markdown tables, multi-tab pages → labeled sections, info/warning/note panels → blockquotes with labels, expand macros → inline content, code blocks with language hints
7. Support recursive crawling of child pages from a root page
8. Respect Confluence page permissions — skip pages the authenticated user cannot access
9. Return list of page IDs crawled, enabling downstream deletion detection for pages removed from Confluence

### Integration Requirements
10. Uses `AtlassianHTTPClient` from Story 3.1 for all API calls
11. Content output format matches existing `crawl_single_page` return structure for downstream compatibility
12. Crawl progress is logged for observability

### Quality Requirements
13. Handles large spaces (1000+ pages) without memory issues via streaming/pagination
14. Graceful degradation when individual pages fail (continue crawling remaining pages)
15. Rate limiting compliance (respects 429 responses and Retry-After headers)

## Tasks / Subtasks

- [ ] **Implement Confluence Space Crawler** (AC: 1, 3, 9, 13)
  - [ ] Create `src/atlassian/confluence_crawler.py`
  - [ ] Implement `crawl_space(space_key)` — fetches all pages in a space
  - [ ] Cloud: Use `GET /wiki/api/v2/spaces/{id}/pages` with cursor pagination
  - [ ] On-Prem: Use `GET /rest/api/space/{key}/content/page` with offset pagination
  - [ ] Implement configurable page limit (`CONFLUENCE_MAX_PAGES_PER_SPACE`)
  - [ ] Collect and return set of all page IDs in space (for deletion detection downstream)
  - [ ] Add progress logging (pages fetched, total estimated)

- [ ] **Implement Single Page Crawler** (AC: 2, 4)
  - [ ] Implement `crawl_page(page_id)` — fetches single page with full content
  - [ ] Cloud: Use `GET /wiki/api/v2/pages/{id}?body-format=atlas_doc_format`
  - [ ] On-Prem: Use `GET /rest/api/content/{id}?expand=body.storage,metadata.labels,ancestors,version`
  - [ ] Extract metadata: title, author, created, modified, labels, space, parent
  - [ ] Parse page URL from `_links.webui` for source tracking

- [ ] **Implement URL-to-Page Resolution** (AC: 2)
  - [ ] Parse Confluence URLs to extract page ID or space+title
  - [ ] Cloud URL pattern: `/wiki/spaces/{key}/pages/{id}/{title}`
  - [ ] On-Prem URL pattern: `/display/{key}/{title}` or `/pages/viewpage.action?pageId={id}`
  - [ ] Resolve page title to page ID via search API if needed

- [ ] **Implement Content Format Conversion** (AC: 5, 6)
  - [ ] Cloud: Convert Atlassian Document Format (ADF/JSON) → Markdown
    - [ ] **PoC core** (must have): paragraph, heading, codeBlock (with language), table, listItem, links, bold/italic/code inline
    - [ ] **PoC enhanced** (should have): info/warning/note panels → blockquotes, expand macros → inline, toc macro → skip
    - [ ] **Future** (nice to have): multi-tab pages (Tabs macro), status macros, date macros, user mentions
  - [ ] On-Prem: Convert XHTML storage format → Markdown
    - [ ] **PoC core**: standard HTML elements (h1-h6, p, ul/ol/li, table, a, code/pre, strong/em)
    - [ ] **PoC core**: `<ac:structured-macro ac:name="code">` → fenced code blocks
    - [ ] **PoC enhanced**: `<ac:structured-macro>` panels → blockquotes, expand → inline
    - [ ] **PoC enhanced**: `<ac:image>` references → Markdown image syntax (URL only, no download)
    - [ ] **Future**: `<ac:structured-macro ac:name="tabs">` → labeled sections
  - [ ] Both: Clean up excessive whitespace, normalize headings, strip invisible/tracking elements

- [ ] **Implement Recursive Child Page Crawling** (AC: 7, 8)
  - [ ] Implement `crawl_page_tree(root_page_id)` — crawls page and all descendants
  - [ ] Cloud: Use `GET /wiki/api/v2/pages/{id}/children` recursively
  - [ ] On-Prem: Use `GET /rest/api/content/{id}/child/page` recursively
  - [ ] Configurable max depth (`CONFLUENCE_MAX_CRAWL_DEPTH`, default: 10)
  - [ ] Skip pages that return 403/404 (permission denied or deleted)
  - [ ] Track crawled page IDs to avoid cycles

- [ ] **Implement Crawl Output Normalization** (AC: 11)
  - [ ] Normalize crawler output to match existing `CrawlResult` structure
  - [ ] Include: url, markdown_content, metadata (title, source_type="confluence", space_key, page_id, labels, author, last_modified)
  - [ ] Include: set of crawled page IDs for deletion detection
  - [ ] Set source identifier format: `confluence:{space_key}` or `confluence:{page_id}`

- [ ] **Error Handling and Resilience** (AC: 8, 14, 15)
  - [ ] Handle 403 (permission denied) — log warning, skip page, continue
  - [ ] Handle 404 (page not found) — log warning, skip, continue
  - [ ] Handle 429 (rate limited) — respect Retry-After header, backoff
  - [ ] Handle 5xx (server error) — retry with exponential backoff (max 3 retries)
  - [ ] Handle network timeouts — configurable timeout (`CONFLUENCE_TIMEOUT=30`)
  - [ ] Aggregate errors in crawl summary (pages_succeeded, pages_failed, errors)

## Dev Notes

### Confluence REST API Reference

**Cloud API v2:**
```
GET /wiki/api/v2/spaces?keys={key}                          → Space info
GET /wiki/api/v2/spaces/{id}/pages?limit=25&cursor={cursor}  → Pages in space
GET /wiki/api/v2/pages/{id}?body-format=atlas_doc_format     → Page content (ADF)
GET /wiki/api/v2/pages/{id}/children?limit=25                → Child pages
```

**On-Prem API v1:**
```
GET /rest/api/space/{key}                                     → Space info
GET /rest/api/space/{key}/content/page?limit=25&start=0       → Pages in space
GET /rest/api/content/{id}?expand=body.storage,metadata.labels → Page content (XHTML)
GET /rest/api/content/{id}/child/page                         → Child pages
```

### Content Format Examples

**ADF (Cloud) Example:**
```json
{
  "type": "doc",
  "content": [
    {
      "type": "heading",
      "attrs": {"level": 1},
      "content": [{"type": "text", "text": "Page Title"}]
    },
    {
      "type": "codeBlock",
      "attrs": {"language": "python"},
      "content": [{"type": "text", "text": "print('hello')"}]
    }
  ]
}
```

**XHTML Storage (On-Prem) Example:**
```html
<h1>Page Title</h1>
<ac:structured-macro ac:name="code">
  <ac:parameter ac:name="language">python</ac:parameter>
  <ac:plain-text-body><![CDATA[print('hello')]]></ac:plain-text-body>
</ac:structured-macro>
```

### Configuration

```bash
# Crawling Limits
CONFLUENCE_MAX_PAGES_PER_SPACE=500    # Max pages to crawl per space
CONFLUENCE_MAX_CRAWL_DEPTH=10         # Max depth for recursive child crawl
CONFLUENCE_TIMEOUT=30                  # Request timeout in seconds
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-19 | 1.0 | Initial story creation | Rado |
| 2026-02-19 | 1.1 | Enhanced complex formatting requirements: tables, tabs, panels, expand macros | Rado |
| 2026-02-19 | 1.2 | Removed attachment handling (page content only), added page deletion detection (AC 9), prioritized ADF conversion scope (PoC core/enhanced/future) | Rado |

## QA Results

### Review Date: 2026-02-19

### Reviewed By: Quinn (Test Architect)

### Story Quality Assessment

Comprehensive story with excellent API reference documentation and format conversion examples. The dual Cloud/On-Prem support is well-specified. Content format conversion (AC 6-7) is the highest-risk task and is appropriately detailed.

### Refactoring Performed

- **File**: `3.2.confluence-content-crawler.md`
  - **Change**: Fixed duplicate AC numbering (Integration Requirements started at 9, colliding with Functional AC 9)
  - **Why**: Duplicate AC numbers cause ambiguous task-to-AC traceability
  - **How**: Re-numbered Integration (10-13), Quality (14-16), updated task AC references

### Compliance Check

- AC Completeness: CONCERNS — see findings
- AC Testability: Pass — all ACs are measurable/verifiable
- Task-to-AC Traceability: Pass (after numbering fix)
- AC Numbering: Pass (after fix)
- Story Format: Pass

### Findings

- [ ] **FUNC-3.2-001 (Medium): No AC for page deletion detection** — Story covers crawling and updating, but if a page is deleted from Confluence between syncs, stale chunks remain in the vector DB forever. Should add AC or delegate explicitly to Story 3.3 incremental sync.
- [ ] **FUNC-3.2-002 (Medium): ADF conversion scope is very large** — AC 7 lists tables, tabs, panels, expand, status, date, mentions — each is a significant parsing effort. Consider defining a "minimum viable conversion" subset for PoC (e.g., headings, paragraphs, code blocks, tables, links) vs. "enhanced" (tabs, panels, macros). This helps prioritize implementation.
- [ ] **FUNC-3.2-003 (Low): Excel/PowerPoint attachment types listed but no processing story** — `CONFLUENCE_ATTACHMENT_TYPES` includes `xlsx,pptx` but Story 3.3 only has PDF and DOCX processing. Either remove xlsx/pptx from the filter defaults or add processing tasks.
- [ ] **SPEC-3.2-001 (Low): Confluence Data Center vs On-Prem** — Story uses "On-Prem" throughout but Atlassian distinguishes Server (EOL) from Data Center. The API is the same, but DC may have clustering/load balancer considerations for rate limiting. Minor — just worth documenting.

### Risk Assessment

- **Content format conversion** is the highest-risk, highest-effort task. ADF is a complex JSON tree; XHTML has many macro variants. Recommend time-boxing PoC conversion to core elements.
- **Attachment download** at scale could saturate network. Concurrency limit (AC 12) mitigates this well.

### Gate Status

Gate: CONCERNS → docs/qa/gates/3.2-confluence-content-crawler.yml

### Recommended Status

Changes Recommended — Clarify page deletion handling and prioritize ADF conversion scope for PoC. Story owner decides final status.

---

### Re-Review Date: 2026-02-19

### Re-Reviewed By: Quinn (Test Architect)

### Story Quality Assessment

Strong improvements in v1.2. Attachment handling cleanly removed. Page deletion detection added as AC 9 with clear downstream contract. ADF conversion scope now properly prioritized into PoC core/enhanced/future tiers — this is exactly the right approach for managing implementation risk.

### Compliance Check

- AC Completeness: Pass — all crawling, conversion, and resilience concerns covered
- AC Testability: Pass — all 15 ACs are measurable/verifiable
- Task-to-AC Traceability: Pass — all ACs mapped to tasks
- AC Numbering: Pass — sequential 1-15, no duplicates
- Story Format: Pass

### Findings (v1.2)

- [x] **FUNC-3.2-001**: RESOLVED — AC 9 adds page deletion detection (return page IDs for downstream)
- [x] **FUNC-3.2-002**: RESOLVED — ADF conversion now tiered: PoC core/enhanced/future
- [x] **FUNC-3.2-003**: RESOLVED — Attachment handling removed entirely
- [ ] **SPEC-3.2-001 (Low): Confluence Data Center vs On-Prem terminology** — Still valid. Minor documentation concern. Story uses "On-Prem" throughout; consider adding a note that "On-Prem" refers to both Server (EOL) and Data Center. Can be addressed in Story 3.5 documentation.
- [ ] **FUNC-3.2-004 (Low): AC 6 "Future" scope items still in AC text** — AC 6 mentions "multi-tab pages → labeled sections" which is marked as "Future" in tasks. AC text should reflect PoC scope or note this is aspirational. Minor — tasks already correctly prioritize.

### Gate Status

Gate: PASS → docs/qa/gates/3.2-confluence-content-crawler.yml

### Recommended Status

Ready for Implementation — All critical and medium findings resolved. Remaining items are low-severity documentation concerns. Story owner decides final status.
