# Story 3.5: Confluence Integration Testing & Documentation

## Status
Pending

## Story
**As a** developer and maintainer,
**I want** comprehensive tests and documentation for the Confluence integration,
**so that** the feature is reliable, maintainable, and easy to adopt.

## Acceptance Criteria

### Testing Requirements
1. Unit tests for all three auth providers (Basic, PAT, OAuth 2.0) with mocked HTTP responses
2. Unit tests for Confluence crawler (space crawl, page crawl, child page recursion, page deletion detection)
3. Unit tests for content format conversion (ADF → Markdown, XHTML → Markdown)
4. Unit tests for content processing pipeline (chunking, embedding, storage)
5. Unit tests for all MCP tool handlers (`crawl_confluence_space`, `crawl_confluence_page`, `get_confluence_sources`, `sync_confluence_space`) with mocked Confluence API
6. Integration test script that validates end-to-end flow with real Confluence instance (skippable in CI)
7. Test coverage target: 85%+ for all new Confluence code
8. All existing tests continue to pass (no regression)

### Documentation Requirements
9. CLAUDE.md updated with Confluence configuration section
10. Setup guide for Confluence Cloud and On-Prem connectivity
11. Configuration reference for all Confluence environment variables
12. Troubleshooting guide for common Confluence integration issues
13. Architecture documentation showing Confluence data flow in the system
14. Example `.env` configurations for Cloud, On-Prem, and OAuth 2.0 setups

## Tasks / Subtasks

- [ ] **Auth Provider Unit Tests** (AC: 1)
  - [ ] Create `tests/test_atlassian_auth.py`
  - [ ] Test BasicAuthProvider: header generation, missing credentials error
  - [ ] Test PATAuthProvider: bearer token header, expired token handling
  - [ ] Test OAuth2Provider: token exchange, refresh flow, expired refresh token
  - [ ] Test AtlassianAuthFactory: auto-detection (Cloud vs On-Prem), explicit override
  - [ ] Test AtlassianHTTPClient: auth injection, retry on 429, error mapping

- [ ] **Confluence Crawler Unit Tests** (AC: 2)
  - [ ] Create `tests/test_confluence_crawler.py`
  - [ ] Test space crawl with mocked paginated API responses (Cloud cursor, On-Prem offset)
  - [ ] Test single page crawl with metadata extraction
  - [ ] Test child page recursion with depth limiting
  - [ ] Test page deletion detection (crawled page IDs returned for downstream comparison)
  - [ ] Test error handling: 403 skip, 404 skip, 429 retry, 5xx retry
  - [ ] Test URL-to-page-ID resolution for various URL formats
  - [ ] Test large space crawling (pagination correctness)

- [ ] **Content Conversion Unit Tests** (AC: 3)
  - [ ] Create `tests/test_confluence_converter.py`
  - [ ] Test ADF to Markdown conversion:
    - [ ] Headings, paragraphs, bold/italic/code inline
    - [ ] Code blocks with language hints
    - [ ] Tables (ADF table nodes → Markdown tables)
    - [ ] Lists (ordered and unordered, nested)
    - [ ] Links
    - [ ] Macros: code, info panel, warning panel, expand
  - [ ] Test XHTML to Markdown conversion:
    - [ ] Standard HTML elements
    - [ ] `<ac:structured-macro>` elements
    - [ ] CDATA sections in macro bodies
  - [ ] Edge cases: empty pages, very large pages, malformed content

- [ ] **Content Processing Unit Tests** (AC: 4)
  - [ ] Create `tests/test_confluence_processor.py`
  - [ ] Test Markdown chunking with Confluence content patterns
  - [ ] Test embedding generation for Confluence chunks
  - [ ] Test vector DB storage with Confluence metadata
  - [ ] Test duplicate detection (version comparison)
  - [ ] Test page deletion detection (orphaned chunks removed)
  - [ ] Test multilingual content embedding (Czech + English chunks)
  - [ ] Test partial failure handling (individual page fails, others continue)

- [ ] **MCP Tool Unit Tests** (AC: 5)
  - [ ] Create `tests/test_confluence_mcp_tools.py`
  - [ ] Test `crawl_confluence_space` tool with mocked crawler
  - [ ] Test `crawl_confluence_page` tool with page_id and page_url inputs
  - [ ] Test `get_confluence_sources` tool
  - [ ] Test `sync_confluence_space` tool:
    - [ ] Incremental sync (only changed pages re-processed)
    - [ ] Force full sync (delete + re-ingest for specific space only)
    - [ ] Page deletion detection (orphaned chunks removed)
    - [ ] Sync response format (pages_checked, pages_updated, pages_unchanged, pages_deleted, chunks_updated)
  - [ ] Test conditional tool registration (enabled/disabled based on config)
  - [ ] Test tool response format matches expected schema
  - [ ] Test error responses for invalid inputs

- [ ] **Integration Test Script** (AC: 6)
  - [ ] Create `tests/test_confluence_integration.py`
  - [ ] Mark all tests with `@pytest.mark.integration`
  - [ ] Skip if `CONFLUENCE_URL` not set in environment
  - [ ] Test: authenticate → crawl page → verify chunks in DB → query → get results
  - [ ] Test: crawl space (limited to 5 pages) → verify storage
  - [ ] Include cleanup (delete test data after run)

- [ ] **Regression Testing** (AC: 8)
  - [ ] Run full existing test suite, verify zero failures
  - [ ] Verify `perform_rag_query` still works for web-crawled content
  - [ ] Verify all existing AI providers still function
  - [ ] Verify conditional tool registration doesn't affect non-Confluence tools

- [ ] **Update CLAUDE.md** (AC: 9, 11)
  - [ ] Add "Confluence Integration" section to CLAUDE.md
  - [ ] Document all Confluence environment variables
  - [ ] Add configuration examples for Cloud, On-Prem, OAuth 2.0
  - [ ] Document new MCP tools (crawl_confluence_space, crawl_confluence_page, get_confluence_sources, sync_confluence_space)
  - [ ] Add Confluence to Quick Start Examples section

- [ ] **Setup Guide** (AC: 10, 14)
  - [ ] Create `docs/confluence-setup.md` (or add to existing docs)
  - [ ] Step-by-step: Atlassian Cloud setup (API token creation)
  - [ ] Step-by-step: On-Prem/DC setup (PAT generation)
  - [ ] Step-by-step: OAuth 2.0 app registration
  - [ ] Connectivity testing instructions
  - [ ] Architecture diagram showing Confluence in the data flow

- [ ] **Troubleshooting Guide** (AC: 12)
  - [ ] Add troubleshooting section to docs
  - [ ] Common issues:
    - Auth failures (wrong credentials, expired tokens)
    - Permission errors (user lacks space/page access)
    - Rate limiting (how to handle, recommended concurrency settings)
    - Content conversion issues (unsupported macros, malformed ADF)
    - Large space crawling (timeout, memory, recommended settings)
    - On-Prem SSL certificate issues (self-signed certs, CONFLUENCE_SSL_VERIFY, CONFLUENCE_CA_BUNDLE)

- [ ] **Example Configurations** (AC: 14)
  - [ ] Create `env.confluence.cloud` example
  - [ ] Create `env.confluence.onprem` example
  - [ ] Create `env.confluence.oauth` example
  - [ ] Update `.env.example` with Confluence section

## Dev Notes

### Test File Structure

```
tests/
├── test_atlassian_auth.py            # Auth provider tests
├── test_confluence_crawler.py        # Crawler tests
├── test_confluence_converter.py      # ADF/XHTML → Markdown tests
├── test_confluence_processor.py      # Content processing tests
├── test_confluence_mcp_tools.py      # MCP tool handler tests
└── test_confluence_integration.py    # End-to-end integration tests
```

### Test Fixtures

Mock data files for test fixtures:
```
tests/fixtures/confluence/
├── adf_simple_page.json              # Simple ADF document
├── adf_complex_page.json             # ADF with tables, macros, code blocks
├── adf_czech_page.json               # Czech-language ADF document for multilingual tests
├── xhtml_simple_page.html            # Simple XHTML storage format
├── xhtml_complex_page.html           # XHTML with macros
├── xhtml_czech_page.html             # Czech-language XHTML page for multilingual tests
├── space_pages_response_cloud.json   # Mocked Cloud space pages API response
└── space_pages_response_onprem.json  # Mocked On-Prem space pages API response
```

### Running Tests

```bash
# Run all Confluence tests
pytest tests/test_confluence*.py tests/test_atlassian*.py -v

# Run only unit tests (no integration)
pytest tests/test_confluence*.py tests/test_atlassian*.py -v -m "not integration"

# Run integration tests (requires CONFLUENCE_URL)
CONFLUENCE_URL=https://your-domain.atlassian.net/wiki \
CONFLUENCE_USERNAME=you@company.com \
CONFLUENCE_API_TOKEN=your-token \
pytest tests/test_confluence_integration.py -v -m integration
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-19 | 1.0 | Initial story creation | Rado |
| 2026-02-19 | 1.1 | Removed attachment test references, added sync_confluence_space tests, added Czech-language test fixtures, updated CLAUDE.md task to include all 4 tools | Rado |

## QA Results

### Review Date: 2026-02-19

### Reviewed By: Quinn (Test Architect)

### Story Quality Assessment

Comprehensive testing story with excellent test file structure, fixture planning, and running instructions. The test fixture directory with mock ADF/XHTML files is a strong foundation. Integration test design with `@pytest.mark.integration` and conditional skip is best practice.

### Compliance Check

- AC Completeness: CONCERNS — minor gaps
- AC Testability: Pass — all testing ACs are verifiable
- Task-to-AC Traceability: Pass
- AC Numbering: Pass — sequential, no duplicates
- Story Format: Pass

### Findings

- [ ] **TEST-3.5-001 (Medium): Missing `sync_confluence_space` MCP tool tests** — MCP Tool Unit Tests (AC 5) do not include tests for the `sync_confluence_space` tool added in Story 3.4. Add: test incremental sync, test force_full sync, test sync response format.
- [ ] **TEST-3.5-002 (Medium): No multilingual search quality tests** — Story 3.3 AC 9 requires Czech embedding quality, but no test validates this. Add: test fixture with Czech Confluence page content, test that Czech query returns relevant Czech chunks.
- [ ] **TEST-3.5-003 (Low): Missing `sync_confluence_space` in CLAUDE.md update task** — The "Update CLAUDE.md" task lists three tools but omits `sync_confluence_space`. Should document all four Confluence MCP tools.
- [ ] **TEST-3.5-004 (Low): No test for incremental sync (version comparison)** — Content Processing Unit Tests (AC 4) include "Test duplicate detection (version comparison)" but not the incremental sync flow (modified-since query → selective re-process → update last_synced_at).
- [ ] **TEST-3.5-005 (Low): Test fixture completeness** — Fixtures should also include: Czech-language ADF/XHTML page, multi-tab page, page with inline images (for converter edge cases).

### Risk Assessment

- Testing story depends on all other stories being complete. Should be the last story implemented.
- Integration tests require access to a real Confluence instance. Recommend setting up a free Atlassian Cloud dev instance for CI/CD.

### Gate Status

Gate: CONCERNS → docs/qa/gates/3.5-confluence-testing-docs.yml

### Recommended Status

Changes Recommended — Add sync tool tests, multilingual test fixtures, and update CLAUDE.md task scope. Story owner decides final status.

---

### Re-Review Date: 2026-02-19

### Re-Reviewed By: Quinn (Test Architect)

### Story Quality Assessment

All critical findings from the initial review have been addressed. Sync tool tests added with good coverage (incremental, force full, deletion detection, response format). Czech-language fixtures added for both ADF and XHTML formats. CLAUDE.md task now documents all 4 MCP tools. Attachment references cleanly removed throughout.

### Compliance Check

- AC Completeness: Pass — all test types covered, all 4 tools tested, multilingual fixtures included
- AC Testability: Pass — all 14 ACs are verifiable
- Task-to-AC Traceability: Pass — all ACs mapped to tasks
- AC Numbering: Pass — sequential 1-14, no duplicates
- Story Format: Pass

### Findings (v1.1)

- [x] **TEST-3.5-001**: RESOLVED — `sync_confluence_space` tests added with 4 sub-tests
- [x] **TEST-3.5-002**: RESOLVED — Czech test fixtures + multilingual embedding test added
- [x] **TEST-3.5-003**: RESOLVED — CLAUDE.md task now lists all 4 tools
- [ ] **TEST-3.5-004 (Low): Full incremental sync flow test** — Content Processing tests cover "duplicate detection (version comparison)" and "page deletion detection" separately, but not the full sync flow (modified-since query → selective re-process → update last_synced_at). This is more of an integration concern and is partially covered by the sync MCP tool tests. Acceptable for PoC.
- [ ] **TEST-3.5-005 (Low): Multi-tab page test fixture missing** — Czech fixtures added, but no multi-tab page fixture for converter edge cases. Low priority since multi-tab conversion is marked "Future" in Story 3.2.
- [ ] **TEST-3.5-006 (Low): No SSL certificate test** — Story 3.1 AC 7 adds SSL/TLS configuration but no dedicated test in 3.5 for `CONFLUENCE_SSL_VERIFY=false` or custom CA bundle scenarios. Auth Provider Unit Tests cover auth headers but not SSL connector config. Could be added as an edge case to AtlassianHTTPClient tests.

### Gate Status

Gate: PASS → docs/qa/gates/3.5-confluence-testing-docs.yml

### Recommended Status

Ready for Implementation — All critical and medium findings resolved. Remaining items are low-severity and can be addressed during implementation. Story owner decides final status.
